<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
    <title>GALAX Community Hub</title>
    <style>
        /* Universal reset for consistent styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body styling with a space-themed gradient background */
        body {
            font-family: 'Courier New', monospace; /* Futuristic font */
            background: linear-gradient(135deg, #1e3c72, #2a5298); /* Deep blue to lighter blue gradient */
            color: white; /* White text for contrast */
            overflow: hidden; /* Prevent body scrolling */
            touch-action: pan-x pan-y pinch-zoom; /* Allow touch actions */
        }

        /* Main game container to fill the viewport */
        #gameContainer {
            position: relative;
            width: 100vw; /* Full viewport width */
            height: 100vh; /* Full viewport height */
            display: flex; /* Flexbox for centering canvas if needed */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        /* Pixi.js will create a canvas inside this container */
        #gameCanvasContainer {
            border: 2px solid #00ffff; /* Cyan border */
            background: #000814; /* Very dark blue background */
            image-rendering: pixelated; /* Ensures pixel art stays sharp */
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            touch-action: pan-x pan-y pinch-zoom; /* Allow touch actions on canvas */
            display: block; /* Remove extra space below canvas */
            transform-origin: center center; /* Set transform origin for zooming */
            width: 100%; /* Ensure container fills space */
            height: 100%; /* Ensure container fills space */
        }
        
        /* Ensure the canvas generated by Pixi.js also fits */
        #gameCanvasContainer canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI overlay, covering the entire screen but non-interactive by default */
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to pass through to canvas by default */
            z-index: 10; /* Ensure UI is above canvas */
        }

        /* Login screen styling */
        #loginScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Center element */
            background: rgba(0, 20, 40, 0.95); /* Dark blue, semi-transparent background */
            border: 2px solid #00ffff; /* Cyan border */
            border-radius: 10px; /* Rounded corners */
            padding: 30px;
            text-align: center;
            pointer-events: all; /* Make interactive */
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); /* Glowing effect */
        }

        #loginScreen h1 {
            color: #00ffff;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 0 0 10px #00ffff; /* Glowing text */
        }

        /* Startup Status Message within Login Screen */
        #startupStatus {
            margin-bottom: 15px;
            color: #7fffd4; /* Aqua color for status */
            font-size: 13px;
            min-height: 1.5em; /* Reserve space to prevent layout shift */
        }

        #loginScreen input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            background: rgba(0, 0, 0, 0.7); /* Dark semi-transparent input field */
            border: 1px solid #00ffff;
            color: white;
            border-radius: 5px;
            outline: none; /* Remove default focus outline */
        }

        #loginScreen button {
            padding: 10px 20px;
            background: #00ffff; /* Cyan button */
            border: none;
            color: #000814; /* Dark text */
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            transition: background 0.3s ease, transform 0.2s ease, opacity 0.3s ease; /* Smooth transitions */
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.3); /* Subtle button glow */
        }

        #loginScreen button:hover:not(:disabled) {
            background: #66ffff; /* Lighter cyan on hover */
            transform: translateY(-2px); /* Slight lift effect */
        }

        #loginScreen button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }


        /* Chat Container - compact by default, expands on click */
        #chatContainer {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 250px;
            height: 40px; /* Compact height */
            background: rgba(0, 20, 40, 0.95);
            border: 2px solid #00ffff;
            border-radius: 20px; /* Pill shape when compact */
            display: none; /* Hidden until logged in */
            pointer-events: all;
            transition: all 0.3s ease; /* Smooth expansion/contraction */
            overflow: hidden; /* Hide content when compact */
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        #chatContainer.expanded {
            height: 200px; /* Expanded height */
            border-radius: 10px; /* Regular rectangle when expanded */
        }

        #chatToggle {
            position: absolute;
            top: 8px;
            left: 15px;
            color: #00ffff;
            font-size: 12px;
            cursor: pointer;
            z-index: 2; /* Ensure toggle is above other chat elements */
            user-select: none; /* Prevent text selection */
        }

        #chatMessages {
            height: 140px; /* Height for messages when expanded */
            overflow-y: auto; /* Scrollable message area */
            padding: 10px;
            font-size: 11px;
            line-height: 1.3;
            margin-top: 30px; /* Space for toggle button */
            display: none; /* Hidden until expanded */
            word-wrap: break-word; /* Ensure long words wrap */
        }

        #chatContainer.expanded #chatMessages {
            display: block;
        }

        #chatInput {
            width: calc(100% - 20px); /* Full width minus padding */
            margin: 10px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ffff;
            color: white;
            border-radius: 5px;
            font-size: 11px;
            display: none; /* Hidden until expanded */
            outline: none;
        }

        #chatContainer.expanded #chatInput {
            display: block;
        }

        /* Minimalist Control Panel */
        #controlPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 20, 40, 0.95);
            border: 2px solid #00ffff;
            border-radius: 25px; /* Pill shape */
            padding: 8px 15px;
            display: none; /* Hidden until logged in */
            pointer-events: all;
            font-size: 12px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .control-button {
            background: none;
            border: none;
            color: #00ffff;
            cursor: pointer;
            margin: 0 8px;
            font-size: 14px;
            padding: 5px;
            border-radius: 3px;
            transition: background 0.2s, transform 0.2s;
        }

        .control-button:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: scale(1.1); /* Slightly enlarge on hover */
        }

        /* Touch Controls - Simplified D-pad */
        #touchControls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: none; /* Hidden by default, shown on mobile */
            pointer-events: all;
        }

        /* Media queries for responsiveness */
        @media (max-width: 768px) {
            #touchControls {
                display: block; /* Show touch controls on smaller screens */
            }
            
            #chatContainer {
                width: calc(100% - 40px); /* Adjust width for mobile */
                left: 20px;
                bottom: 10px;
            }
            
            #controlPanel {
                right: 10px;
                top: 10px;
            }

            #loginScreen {
                width: 90%;
                max-width: 300px;
            }
        }

        .dpad {
            width: 100px;
            height: 100px;
            position: relative;
            background: rgba(0, 20, 40, 0.9);
            border: 2px solid #00ffff;
            border-radius: 50%; /* Circular D-pad */
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .dpad-button {
            position: absolute;
            width: 30px; /* Slightly larger touch targets */
            height: 30px;
            background: rgba(0, 255, 255, 0.3);
            border: 1px solid #00ffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00ffff;
            font-size: 14px; /* Larger font for arrows */
            font-weight: bold;
            user-select: none;
            touch-action: manipulation; /* Allow touch manipulation without default browser gestures */
            transition: background 0.2s;
        }

        .dpad-button:active {
            background: rgba(0, 255, 255, 0.6); /* Feedback on touch */
        }

        /* D-pad button positioning */
        .dpad-up { top: 5px; left: 35px; }
        .dpad-down { bottom: 5px; left: 35px; }
        .dpad-left { left: 5px; top: 35px; }
        .dpad-right { right: 5px; top: 35px; }

        /* Player Profile Modal */
        #playerProfile {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 20, 40, 0.98);
            border: 2px solid #00ffff;
            border-radius: 15px;
            padding: 25px;
            display: none; /* Hidden by default */
            pointer-events: all;
            min-width: 280px;
            max-width: 90%; /* Responsive width */
            text-align: center;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
            z-index: 20; /* Ensure it's on top */
        }

        #playerProfile h3 {
            color: #00ffff;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .profile-avatar {
            margin: 15px auto;
            width: 64px;
            height: 64px;
            position: relative;
            border: 2px dashed rgba(0, 255, 255, 0.5); /* Avatar border */
            border-radius: 8px;
        }

        .profile-info {
            margin: 10px 0;
            font-size: 12px;
            color: #cccccc;
        }

        .profile-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }

        .profile-btn {
            padding: 8px 16px;
            background: #00ffff;
            border: none;
            color: #000814;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .profile-btn:hover {
            background: #66ffff;
            transform: translateY(-2px);
        }

        .profile-btn.secondary {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            border: 1px solid #00ffff;
        }

        /* Avatar customization panel */
        .avatar-customization {
            position: absolute;
            top: 50%;
            right: 50px;
            transform: translateY(-50%);
            background: rgba(0, 20, 40, 0.98);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            display: none;
            pointer-events: all;
            max-width: 250px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            z-index: 20;
        }

        @media (max-width: 768px) {
            .avatar-customization {
                width: 90%;
                max-width: 280px;
                right: 50%;
                transform: translateX(50%) translateY(-50%); /* Re-center for mobile */
            }
        }

        .color-picker {
            display: flex;
            gap: 8px;
            margin: 8px 0;
            flex-wrap: wrap; /* Allow colors to wrap */
            justify-content: center; /* Center color options */
        }

        .color-option {
            width: 30px; /* Larger color swatch */
            height: 30px;
            border: 2px solid #00ffff;
            cursor: pointer;
            border-radius: 5px;
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1); /* Enlarge on hover */
        }

        .color-option.selected {
            box-shadow: 0 0 8px #00ffff, inset 0 0 8px #00ffff; /* Stronger glow when selected */
        }

        /* Online indicator */
        #onlineCount {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 20, 40, 0.9);
            border: 2px solid #00ffff;
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 11px;
            color: #00ffff;
            display: none;
            pointer-events: all;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        /* In-App Message Box */
        #messageBox {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 40, 80, 0.9); /* Darker blue */
            border: 2px solid #00ffff;
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            font-size: 14px;
            text-align: center;
            z-index: 100; /* Ensure it's on top of everything */
            opacity: 0; /* Hidden by default */
            transition: opacity 0.5s ease-in-out;
            pointer-events: none; /* Don't block clicks underneath */
            max-width: 80%; /* Responsive width */
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
        }

        #messageBox.show {
            opacity: 1;
        }

        #messageBox.error {
            background: rgba(80, 0, 0, 0.9); /* Red background for errors */
            border-color: #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
        }
    </style>
    <!-- Pixi.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.x/pixi.min.js"></script>
</head>
<body>
    <div id="gameContainer">
        <!-- Pixi.js will attach its canvas here -->
        <div id="gameCanvasContainer"></div>
        
        <div id="ui">
            <!-- In-App Message Box (for general game messages) -->
            <div id="messageBox"></div>

            <!-- Login Screen -->
            <div id="loginScreen">
                <h1>GALAX Community Hub</h1>
                <!-- Startup Status Message -->
                <div id="startupStatus" class="status-message">Initializing...</div>
                <div>
                    <input type="text" id="usernameInput" placeholder="Enter Username" maxlength="20" aria-label="Username input">
                </div>
                <div>
                    <button id="joinButton" onclick="joinCommunity()" disabled>Join Community</button>
                </div>
            </div>

            <!-- Online Count Display -->
            <div id="onlineCount">
                <span id="onlineNumber">0</span> online
            </div>

            <!-- Control Panel -->
            <div id="controlPanel">
                <button class="control-button" onclick="toggleCustomization()" title="Customize Avatar" aria-label="Customize Avatar">👤</button>
                <button class="control-button" onclick="showHelp()" title="Help" aria-label="Help">?</button>
                <button class="control-button" onclick="toggleFullscreen()" title="Fullscreen" aria-label="Toggle Fullscreen">⛶</button>
            </div>

            <!-- Chat Container -->
            <div id="chatContainer">
                <div id="chatToggle" onclick="toggleChat()" aria-label="Toggle Chat">💬 Chat</div>
                <div id="chatMessages" role="log" aria-live="polite"></div>
                <input type="text" id="chatInput" placeholder="Type message..." onkeypress="handleChatInput(event)" aria-label="Chat input">
            </div>

            <!-- Touch Controls (D-pad) -->
            <div id="touchControls">
                <div class="dpad">
                    <div class="dpad-button dpad-up" ontouchstart="startTouch('up')" ontouchend="endTouch('up')" aria-label="Move Up">↑</div>
                    <div class="dpad-button dpad-down" ontouchstart="startTouch('down')" ontouchend="endTouch('down')" aria-label="Move Down">↓</div>
                    <div class="dpad-button dpad-left" ontouchstart="startTouch('left')" ontouchend="endTouch('left')" aria-label="Move Left">←</div>
                    <div class="dpad-button dpad-right" ontouchstart="startTouch('right')" ontouchend="endTouch('right')" aria-label="Move Right">→</div>
                </div>
            </div>

            <!-- Player Profile Modal -->
            <div id="playerProfile" role="dialog" aria-modal="true" aria-labelledby="profileName">
                <h3 id="profileName">Player Name</h3>
                <div class="profile-avatar">
                    <canvas id="profileAvatar" width="64" height="64" aria-label="Player Avatar"></canvas>
                </div>
                <div class="profile-info">
                    <div>Status: <span id="profileStatus">Online</span></div>
                    <div>Joined: <span id="profileJoined">Just now</span></div>
                </div>
                <div class="profile-actions">
                    <button class="profile-btn" onclick="sendFriendRequest()">Add Friend</button>
                    <button class="profile-btn secondary" onclick="closeProfile()">Close</button>
                </div>
            </div>

            <!-- Avatar Customization Panel -->
            <div id="avatarCustomization" class="avatar-customization" role="dialog" aria-modal="true" aria-labelledby="customizeAvatarTitle">
                <h3 id="customizeAvatarTitle" style="color: #00ffff; margin-bottom: 15px; font-size: 16px;">Customize Avatar</h3>
                <div>
                    <label style="color: white; font-size: 12px;" for="bodyColorPicker">Body Color:</label>
                    <div class="color-picker" id="bodyColorPicker"></div>
                </div>
                <div>
                    <label style="color: white; font-size: 12px;" for="hairColorPicker">Hair Color:</label>
                    <div class="color-picker" id="hairColorPicker"></div>
                </div>
                <button onclick="closeCustomization()" style="margin-top: 15px; padding: 8px 16px; background: #00ffff; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">Done</button>
            </div>
        </div>
    </div>

    <script>
        // --- Game State Management ---
        let gameState = {
            isLoggedIn: false,          // Tracks if the user has logged in
            username: '',               // Current player's username
            players: new Map(),         // Stores all active players (username -> player object)
            currentPlayer: null,        // Reference to the current user's player object
            chatExpanded: false,        // State of the chat panel (expanded or compact)
            customizationVisible: false,// State of the avatar customization panel
            touchKeys: {},              // Tracks active touch d-pad inputs
            selectedPlayer: null        // Stores the player object of the currently viewed profile
        };

        // --- Pixi.js Application Setup ---
        let app; // Pixi.js Application instance
        let playerContainer; // Container for all player sprites
        let gridGraphics; // Graphics object for the background grid

        // Avatar colors available for customization
        const avatarColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd', '#98d8c8', '#f7dc6f'];

        // --- In-App Message Box Function (for general game notifications) ---
        let messageBoxTimeout;
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.classList.add('show');
            if (isError) {
                messageBox.classList.add('error');
            } else {
                messageBox.classList.remove('error');
            }

            // Clear any existing timeout to prevent messages from disappearing too quickly
            clearTimeout(messageBoxTimeout);
            messageBoxTimeout = setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Message disappears after 3 seconds
        }

        // --- Startup Status Message Function (for loading screen messages) ---
        function updateStartupStatus(message) {
            const startupStatusElement = document.getElementById('startupStatus');
            if (startupStatusElement) {
                startupStatusElement.textContent = message;
            }
        }


        // --- Initialization ---
        // Ensures the game initializes after the DOM is fully loaded.
        window.onload = function() {
            initGame();
        };

        /**
         * Initializes the game: sets up Pixi.js, color pickers, and event listeners.
         */
        function initGame() {
            updateStartupStatus('Initializing Pixi.js...');
            // Initialize Pixi.js Application
            app = new PIXI.Application({
                width: window.innerWidth,
                height: window.innerHeight,
                backgroundColor: 0x000814, // Same background color as before
                antialias: false, // For crisp pixel art
                autoDensity: true, // Handle retina displays
                resolution: window.devicePixelRatio || 1, // Use device pixel ratio
            });
            document.getElementById('gameCanvasContainer').appendChild(app.view);
            updateStartupStatus('Setting up game elements...');

            // Create a container for all players
            playerContainer = new PIXI.Container();
            app.stage.addChild(playerContainer);

            // Create a graphics object for the grid (will be drawn first)
            gridGraphics = new PIXI.Graphics();
            app.stage.addChildAt(gridGraphics, 0); // Add grid at the bottom layer

            // Set up color selection options for avatar customization
            setupColorPickers();
            updateStartupStatus('Configuring input and events...');
            
            // Add event listener for window resizing to make the canvas responsive
            window.addEventListener('resize', resizeCanvas);

            // Draw initial grid
            drawGrid();

            // Enable pinch zoom on Pixi.js canvas using wheel event (for desktop)
            let scale = 1; // Initial zoom scale
            app.view.addEventListener('wheel', (e) => {
                e.preventDefault(); // Prevent page scrolling
                const delta = e.deltaY > 0 ? 0.9 : 1.1; // Zoom out (0.9) or zoom in (1.1)
                scale *= delta;
                scale = Math.min(Math.max(0.5, scale), 3); // Limit zoom between 0.5x and 3x
                app.stage.scale.set(scale); // Apply scale to the entire stage
            });

            // Prevent default touch behaviors while allowing pinch zoom (mobile)
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    // Allow pinch zoom by not preventing default for multi-touch
                    return;
                }
            }, { passive: true }); // Set passive to true for better scrolling performance

            // Start the main game loop using Pixi.js's ticker
            app.ticker.add(gameLoop);

            // Enable the join button once Pixi.js is fully initialized
            document.getElementById('joinButton').disabled = false;
            updateStartupStatus('Game Ready! Enter your username.');
        }

        /**
         * Resizes the Pixi.js renderer and canvas to fill the available window space.
         * Called on initial load and window resize.
         */
        function resizeCanvas() {
            app.renderer.resize(window.innerWidth, window.innerHeight);
            // Re-render grid after resize
            drawGrid();
        }

        /**
         * Populates the color picker sections with clickable color options.
         */
        function setupColorPickers() {
            const bodyPicker = document.getElementById('bodyColorPicker');
            const hairPicker = document.getElementById('hairColorPicker');
            
            // Create color options for body
            avatarColors.forEach(color => {
                const bodyOption = document.createElement('div');
                bodyOption.className = 'color-option';
                bodyOption.style.backgroundColor = color;
                // Pass the event object to the handler
                bodyOption.onclick = (e) => selectBodyColor(color, e); 
                bodyPicker.appendChild(bodyOption);
            });

            // Create color options for hair
            avatarColors.forEach(color => {
                const hairOption = document.createElement('div');
                hairOption.className = 'color-option';
                hairOption.style.backgroundColor = color;
                // Pass the event object to the handler
                hairOption.onclick = (e) => selectHairColor(color, e);
                hairPicker.appendChild(hairOption);
            });
        }

        /**
         * Sets the current player's body color and updates the UI.
         * @param {string} color - The hex color code.
         * @param {Event} e - The click event object.
         */
        function selectBodyColor(color, e) {
            // Remove 'selected' class from all body color options
            document.querySelectorAll('#bodyColorPicker .color-option').forEach(el => el.classList.remove('selected'));
            // Add 'selected' class to the clicked option
            if (e && e.target) {
                e.target.classList.add('selected');
            }
            // Update current player's body color and redraw their avatar
            if (gameState.currentPlayer) {
                gameState.currentPlayer.bodyColor = color;
                // Update the Pixi.js avatar graphic directly
                if (gameState.currentPlayer.pixiSprite) {
                    updatePixiAvatar(gameState.currentPlayer);
                }
            }
        }

        /**
         * Sets the current player's hair color and updates the UI.
         * @param {string} color - The hex color code.
         * @param {Event} e - The click event object.
         */
        function selectHairColor(color, e) {
            // Remove 'selected' class from all hair color options
            document.querySelectorAll('#hairColorPicker .color-option').forEach(el => el.classList.remove('selected'));
            // Add 'selected' class to the clicked option
            if (e && e.target) {
                e.target.classList.add('selected');
            }
            // Update current player's hair color and redraw their avatar
            if (gameState.currentPlayer) {
                gameState.currentPlayer.hairColor = color;
                // Update the Pixi.js avatar graphic directly
                if (gameState.currentPlayer.pixiSprite) {
                    updatePixiAvatar(gameState.currentPlayer);
                }
            }
        }

        /**
         * Handles the user joining the community.
         * Validates username, creates player, updates UI.
         */
        function joinCommunity() {
            showMessage('Attempting to join community...');
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();

            if (username) {
                showMessage('Username is valid. Proceeding with login...');
                gameState.username = username;
                gameState.isLoggedIn = true;

                // Canvas should be ready now that the button is enabled
                const initialX = Math.random() * (app.screen.width - 100) + 50;
                const initialY = Math.random() * (app.screen.height - 100) + 50;

                gameState.currentPlayer = {
                    username: username,
                    x: initialX,
                    y: initialY,
                    bodyColor: '#4ecdc4', // Default body color
                    hairColor: '#ff6b6b', // Default hair color
                    direction: 'down',     // Initial facing direction
                    isMoving: false,       // Not moving initially
                    joinTime: new Date()   // Timestamp of joining
                };

                showMessage('Adding current player to game state and Pixi.js...');
                addPlayer(gameState.currentPlayer);

                // Hide login screen and show other UI elements
                showMessage('Updating UI visibility...');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('onlineCount').style.display = 'block';
                document.getElementById('controlPanel').style.display = 'flex'; // Use flex for button alignment
                document.getElementById('chatContainer').style.display = 'block';
                // Hide the startup status message as login screen is gone
                document.getElementById('startupStatus').style.display = 'none'; 
                showMessage('Login screen hidden, game UI elements shown.');

                // Add a welcome message to the chat
                addChatMessage('System', `Welcome ${username}!`);
                
                // Simulate other users joining after a short delay
                setTimeout(() => addSimulatedUsers(), 2000);
                
                // Update the online player count display
                updateOnlineCount();
                showMessage('Successfully joined as ' + username + '!');

            } else {
                showMessage('Error: Username cannot be empty!', true);
                usernameInput.style.border = '2px solid red';
                usernameInput.placeholder = 'Username cannot be empty!';
                setTimeout(() => {
                    usernameInput.style.border = '1px solid #00ffff';
                    usernameInput.placeholder = 'Enter Username';
                }, 2000);
            }
        }

        /**
         * Adds a player to the game state and creates their Pixi.js sprite.
         * @param {Object} player - The player object to add.
         */
        function addPlayer(player) {
            gameState.players.set(player.username, player);
            // Create Pixi.js sprite for the player
            player.pixiSprite = createPixiAvatar(player);
            player.pixiSprite.x = player.x;
            player.pixiSprite.y = player.y;
            playerContainer.addChild(player.pixiSprite);
        }

        /**
         * Adds a few simulated users to the game for demonstration purposes.
         */
        function addSimulatedUsers() {
            const simulatedUsers = ['Alice', 'Bob', 'Charlie', 'Diana'];
            simulatedUsers.forEach((name, index) => {
                setTimeout(() => {
                    // Create a simulated user object
                    const user = {
                        username: name,
                        x: Math.random() * (app.screen.width - 100) + 50,
                        y: Math.random() * (app.screen.height - 100) + 50,
                        bodyColor: avatarColors[Math.floor(Math.random() * avatarColors.length)],
                        hairColor: avatarColors[Math.floor(Math.random() * avatarColors.length)],
                        direction: 'down',
                        isMoving: false,
                        joinTime: new Date(Date.now() - Math.random() * 3600000) // Random join time up to 1 hour ago
                    };
                    addPlayer(user); // Add to map and create Pixi sprite
                    updateOnlineCount(); // Update count
                    
                    // Make simulated users move occasionally
                    setInterval(() => {
                        if (Math.random() < 0.08) { // 8% chance to move every 2 seconds
                            moveSimulatedUser(user);
                        }
                    }, 2000);
                }, index * 800); // Stagger joins
            });
        }

        /**
         * Simulates movement for a given user.
         * @param {Object} user - The user object to move.
         */
        function moveSimulatedUser(user) {
            const directions = ['up', 'down', 'left', 'right'];
            const direction = directions[Math.floor(Math.random() * directions.length)];
            const speed = 2; // Movement speed
            
            user.direction = direction;
            user.isMoving = true;
            
            // Update position based on direction, clamped within Pixi screen boundaries
            switch (direction) {
                case 'up': user.y = Math.max(20, user.y - speed * 8); break;
                case 'down': user.y = Math.min(app.screen.height - 40, user.y + speed * 8); break;
                case 'left': user.x = Math.max(20, user.x - speed * 8); break;
                case 'right': user.x = Math.min(app.screen.width - 40, user.x + speed * 8); break;
            }
            
            setTimeout(() => user.isMoving = false, 400);
        }

        /**
         * Updates the displayed count of online players.
         */
        function updateOnlineCount() {
            document.getElementById('onlineNumber').textContent = gameState.players.size;
        }

        // --- Input Handling (Keyboard) ---
        const keys = {}; // Object to track pressed keyboard keys
        
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true; // Set key to true when pressed
            
            // Tab key to toggle chat, prevent default browser behavior
            if (e.key === 'Tab') {
                e.preventDefault();
                toggleChat();
            }
            
            // 'C' key to toggle customization panel
            if (e.key.toLowerCase() === 'c') {
                toggleCustomization();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false; // Set key to false when released
        });

        /**
         * Handles the movement logic for the current player based on
         * keyboard and touch inputs.
         */
        function handleMovement() {
            if (!gameState.currentPlayer) return; // Only move if a player exists
            
            const speed = 3; // Player movement speed
            let moved = false; // Flag to track if player moved
            
            // Check combined keyboard (WASD/arrows) and touch d-pad inputs
            const upPressed = keys['w'] || keys['arrowup'] || gameState.touchKeys['up'];
            const downPressed = keys['s'] || keys['arrowdown'] || gameState.touchKeys['down'];
            const leftPressed = keys['a'] || keys['arrowleft'] || gameState.touchKeys['left'];
            const rightPressed = keys['d'] || keys['arrowright'] || gameState.touchKeys['right'];
            
            // Apply movement and set direction based on input, clamped within Pixi screen boundaries
            if (upPressed) {
                gameState.currentPlayer.y = Math.max(20, gameState.currentPlayer.y - speed);
                gameState.currentPlayer.direction = 'up';
                moved = true;
            }
            if (downPressed) {
                gameState.currentPlayer.y = Math.min(app.screen.height - 40, gameState.currentPlayer.y + speed);
                gameState.currentPlayer.direction = 'down';
                moved = true;
            }
            if (leftPressed) {
                gameState.currentPlayer.x = Math.max(20, gameState.currentPlayer.x - speed);
                gameState.currentPlayer.direction = 'left';
                moved = true;
            }
            if (rightPressed) {
                gameState.currentPlayer.x = Math.min(app.screen.width - 40, gameState.currentPlayer.x + speed);
                gameState.currentPlayer.direction = 'right';
                moved = true;
            }
            
            gameState.currentPlayer.isMoving = moved;
        }

        // --- Touch Controls (Mobile D-pad) ---
        /**
         * Activates a touch direction when a d-pad button is pressed.
         * @param {string} direction - 'up', 'down', 'left', or 'right'.
         */
        function startTouch(direction) {
            gameState.touchKeys[direction] = true;
        }

        /**
         * Deactivates a touch direction when a d-pad button is released.
         * @param {string} direction - 'up', 'down', 'left', or 'right'.
         */
        function endTouch(direction) {
            gameState.touchKeys[direction] = false;
        }

        // --- Chat Functionality ---
        /**
         * Toggles the expansion state of the chat container.
         */
        function toggleChat() {
            gameState.chatExpanded = !gameState.chatExpanded;
            const chatContainer = document.getElementById('chatContainer');
            const chatInput = document.getElementById('chatInput');
            
            if (gameState.chatExpanded) {
                chatContainer.classList.add('expanded');
                chatInput.focus(); // Focus input when chat expands
            } else {
                chatContainer.classList.remove('expanded');
                chatInput.blur(); // Remove focus when chat collapses
            }
        }

        /**
         * Handles sending messages from the chat input when Enter is pressed.
         * @param {Event} event - The keyboard event.
         */
        function handleChatInput(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const message = input.value.trim();
                
                if (message) {
                    addChatMessage(gameState.username, message); // Add message to chat history
                    input.value = ''; // Clear input field
                    
                    // Simulate occasional responses from other users
                    if (Math.random() < 0.25) { // 25% chance of a simulated response
                        const responses = ['Hello!', 'Nice!', 'How are you?', 'Cool!', 'Sounds good!'];
                        // Get list of other users
                        const users = Array.from(gameState.players.keys()).filter(u => u !== gameState.username);
                        if (users.length > 0) {
                            const randomUser = users[Math.floor(Math.random() * users.length)];
                            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                            setTimeout(() => {
                                addChatMessage(randomUser, randomResponse);
                            }, 1000 + Math.random() * 2000); // Respond after 1-3 seconds
                        }
                    }
                }
            }
        }

        /**
         * Adds a new message to the chat display.
         * @param {string} username - The sender's username.
         * @param {string} message - The message content.
         */
        function addChatMessage(username, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `<strong style="color: #00ffff;">${username}:</strong> ${message}`;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom to show latest message
            
            // Limit message history to prevent excessive DOM elements
            if (chatMessages.children.length > 50) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
        }

        // --- UI Control Functions ---
        /**
         * Toggles the visibility of the avatar customization panel.
         */
        function toggleCustomization() {
            gameState.customizationVisible = !gameState.customizationVisible;
            const customizationPanel = document.getElementById('avatarCustomization');
            customizationPanel.style.display = gameState.customizationVisible ? 'block' : 'none';
        }

        /**
         * Hides the avatar customization panel.
         */
        function closeCustomization() {
            gameState.customizationVisible = false;
            document.getElementById('avatarCustomization').style.display = 'none';
        }

        /**
         * Displays a help message in the chat.
         */
        function showHelp() {
            addChatMessage('System', 'Controls: WASD/arrows to move, click player names/avatars for profiles, pinch to zoom. Press C to customize.');
        }

        /**
         * Toggles fullscreen mode for the document.
         */
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // --- Player Profile System ---
        /**
         * Displays the profile modal for a selected player.
         * @param {Object} player - The player object whose profile is to be shown.
         */
        function showPlayerProfile(player) {
            gameState.selectedPlayer = player;
            document.getElementById('profileName').textContent = player.username;
            document.getElementById('profileStatus').textContent = 'Online';
            
            // Calculate and display join time
            const joinTime = new Date(player.joinTime);
            const minutesAgo = Math.floor((Date.now() - joinTime.getTime()) / 60000);
            const hoursAgo = Math.floor(minutesAgo / 60);

            let timeAgoText;
            if (minutesAgo < 1) {
                timeAgoText = 'Just now';
            } else if (minutesAgo < 60) {
                timeAgoText = `${minutesAgo}m ago`;
            } else if (hoursAgo < 24) {
                timeAgoText = `${hoursAgo}h ago`;
            } else {
                timeAgoText = joinTime.toLocaleDateString(); // Show full date if more than a day
            }
            document.getElementById('profileJoined').textContent = timeAgoText;
            
            // Draw player's avatar in the profile modal using a temporary canvas
            const profileCanvas = document.getElementById('profileAvatar');
            const profileCtx = profileCanvas.getContext('2d');
            profileCtx.clearRect(0, 0, 64, 64); // Clear previous avatar
            // Draw at a larger scale for the profile using the utility function
            drawPixelAvatarToContext(player, 16, 16, profileCtx, 2); 
            
            document.getElementById('playerProfile').style.display = 'block';
        }

        /**
         * Hides the player profile modal.
         */
        function closeProfile() {
            document.getElementById('playerProfile').style.display = 'none';
            gameState.selectedPlayer = null; // Clear selected player
        }

        /**
         * Simulates sending a friend request to the currently selected player.
         */
        function sendFriendRequest() {
            if (gameState.selectedPlayer) {
                addChatMessage('System', `Friend request sent to ${gameState.selectedPlayer.username}`);
                closeProfile(); // Close profile after sending request
            }
        }

        // --- Pixi.js Rendering Functions ---

        /**
         * Creates a Pixi.js Graphics object representing a pixel-art avatar.
         * This function builds the avatar shapes using Pixi.Graphics.
         * @param {Object} player - The player object containing avatar data.
         * @returns {PIXI.Container} A Pixi.js Container holding the avatar graphics and text.
         */
        function createPixiAvatar(player) {
            const container = new PIXI.Container();
            container.name = `player_${player.username}`; // Name for easier debugging/identification

            // Graphics for the body, head, hair, eyes
            const avatarGraphics = new PIXI.Graphics();
            container.addChild(avatarGraphics);

            // Text for the username
            const usernameText = new PIXI.Text(player.username, {
                fontFamily: 'Courier New',
                fontSize: 11,
                fill: 0x00ffff, // Cyan color
                align: 'center',
            });
            usernameText.anchor.set(0.5); // Center the text anchor
            usernameText.x = 16; // Avatar width / 2
            usernameText.y = -5; // Position above the avatar
            container.addChild(usernameText);

            // Store references to graphics and text for easy updates
            player._avatarGraphics = avatarGraphics;
            player._usernameText = usernameText;

            // Initially draw the avatar
            updatePixiAvatar(player);

            // Make the entire container interactive for clicks
            container.eventMode = 'static'; // Enable interaction for the container
            container.hitArea = new PIXI.Rectangle(0, -20, 32, 50); // Define a broader hit area for clicking
            container.cursor = 'pointer'; // Show pointer cursor on hover
            container.on('pointerdown', (event) => { // Use pointerdown for mobile touch events
                if (player !== gameState.currentPlayer) { // Don't show profile for self
                    showPlayerProfile(player);
                }
            });

            return container;
        }

        /**
         * Updates the drawing of an existing Pixi.js avatar graphics based on player data.
         * This is called when color or state changes.
         * @param {Object} player - The player object with updated avatar data.
         */
        function updatePixiAvatar(player) {
            const graphics = player._avatarGraphics;
            if (!graphics) return;

            graphics.clear(); // Clear previous drawing

            const scale = 1; // Base scale for in-game avatar

            // Body (fillRect(x, y, width, height))
            graphics.beginFill(parseInt(player.bodyColor.replace('#', '0x')));
            graphics.drawRect(8 * scale, 12 * scale, 16 * scale, 20 * scale);
            graphics.endFill();
            
            // Head
            graphics.beginFill(parseInt(player.bodyColor.replace('#', '0x')));
            graphics.drawRect(6 * scale, 4 * scale, 20 * scale, 16 * scale);
            graphics.endFill();
            
            // Hair
            graphics.beginFill(parseInt(player.hairColor.replace('#', '0x')));
            graphics.drawRect(4 * scale, 2 * scale, 24 * scale, 8 * scale);
            graphics.endFill();
            
            // Eyes
            graphics.beginFill(0x000000); // Black
            graphics.drawRect(10 * scale, 8 * scale, 2 * scale, 2 * scale);
            graphics.drawRect(20 * scale, 8 * scale, 2 * scale, 2 * scale);
            graphics.endFill();
        }

        /**
         * Draws a pixel-art avatar onto a standard HTML Canvas 2D context.
         * Used specifically for the player profile modal.
         * @param {Object} player - The player object containing avatar data.
         * @param {number} x - X coordinate to draw the avatar.
         * @param {number} y - Y coordinate to draw the avatar.
         * @param {CanvasRenderingContext2D} context - The canvas rendering context to draw on.
         * @param {number} scale - Scaling factor for the avatar drawing.
         */
        function drawPixelAvatarToContext(player, x, y, context, scale = 1) {
            context.imageSmoothingEnabled = false; // Ensure pixel rendering is sharp
            
            // Body
            context.fillStyle = player.bodyColor;
            context.fillRect(x + 8 * scale, y + 12 * scale, 16 * scale, 20 * scale);
            
            // Head
            context.fillStyle = player.bodyColor;
            context.fillRect(x + 6 * scale, y + 4 * scale, 20 * scale, 16 * scale);
            
            // Hair
            context.fillStyle = player.hairColor;
            context.fillRect(x + 4 * scale, y + 2 * scale, 24 * scale, 8 * scale);
            
            // Eyes
            context.fillStyle = '#000000'; // Black eyes
            context.fillRect(x + 10 * scale, y + 8 * scale, 2 * scale, 2 * scale);
            context.fillRect(x + 20 * scale, y + 8 * scale, 2 * scale, 2 * scale);
        }

        /**
         * Draws the subtle grid background using Pixi.js Graphics.
         * This function is called once on init and on resize.
         */
        function drawGrid() {
            gridGraphics.clear(); // Clear existing grid
            gridGraphics.lineStyle(1, 0x00ffff, 0.05); // Line width, color (cyan), alpha

            const gridSize = 50;
            // Draw vertical lines
            for (let x = 0; x <= app.screen.width; x += gridSize) {
                gridGraphics.moveTo(x, 0);
                gridGraphics.lineTo(x, app.screen.height);
            }
            // Draw horizontal lines
            for (let y = 0; y <= app.screen.height; y += gridSize) {
                gridGraphics.moveTo(0, y);
                gridGraphics.lineTo(app.screen.width, y);
            }
        }

        /**
         * The main game loop: handles movement, updates Pixi.js sprites positions, and applies animations.
         * This function is called by Pixi.js's ticker.
         * @param {number} delta - The time elapsed since the last frame in milliseconds (often normalized to 1).
         */
        function gameLoop(delta) {
            if (gameState.isLoggedIn) {
                handleMovement(); // Process player movement if logged in
            }
            
            // Update Pixi.js sprite positions and animations
            gameState.players.forEach(player => {
                if (player.pixiSprite) {
                    // Update Pixi sprite position based on player's data
                    player.pixiSprite.x = player.x;
                    player.pixiSprite.y = player.y;

                    // Apply simple animation for movement
                    if (player.isMoving) {
                        // Apply a vertical bobbing effect based on global time
                        // Using Date.now() for continuous time-based animation
                        player.pixiSprite.y += Math.sin(Date.now() * 0.01) * 0.5;
                    }
                }
            });
            // Pixi.js automatically renders on each ticker update if autoStart is true (default)
        }
    </script>
</body>
</html>